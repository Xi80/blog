<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<title>Vide</title>


<link rel="stylesheet" href="/styles/main.css">


    <meta name="generator" content="Hexo 6.3.0"></head>
    <body>
        <div class="container">
            <header>
<div class="main">
<div class="title">
    <a href="#" class="logo">Vide</a>
</div>
<div class="site-nav">
    <ul id="menu" class="menu">
    
        <li class="menu-item text-underline">
            <a href="/">ホーム</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/archives">記事</a>
        </li>
    
        <li class="menu-item text-underline">
            <a href="/about/">About</a>
        </li>
            
    </ul>
</div>
</div>
</header>
            <main class="main">
                <section class="posts clearfix">
    <div class="posts-wrapper">
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/11/30/mc68302-general-description/">MC68302　ユーザーマニュアル(私家版) 1.概要</a>
            </div>
            <p class="sub">11月 30 2022</p>
            <div class="post-content">
                
                    <h1 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h1><p>このマニュアルは私が独自に解釈して作成した私家版のユーザーマニュアルです。</p>
<p>内容の正確性については一切保証しませんので、実際の使用に当たっては１次ソースを必ず参照してください。</p>
<p>必要ないと思ったペリフェラル、箇所については翻訳を省いています(特にCPのプロトコル部分)</p>
<hr/>

<h1 id="第1章-概要"><a href="#第1章-概要" class="headerlink" title="第1章 概要"></a>第1章 概要</h1><p>MC68302 統合通信プロセッサ(以下IMP)は多種多様な制御装置に必要な主要機能を組み込んだ超大規模集積回路(VLSI)です。このデバイスは特に通信業界のアプリケーションに適しています。</p>
<p>IMPは密に結合された業界標準であるM68000マイクロプロセッサと柔軟な通信アーキテクチャを提供する最初のデバイスです。IMPは複数の一般的な業界インターフェイス(ISDNベーシックレートやターミナルアダプタを含む)をサポートするように構成できます。異なるプロトコルの同時動作は、アーキテクチャやプログラマブルな機能を組み合わせることにより容易に実現することができます。データコンセントレータ、ラインカード、モデム、ブリッジ、ゲートウェイなどがこのデバイスに適したアプリケーション例です。</p>
<p>IMPはM68000マイクロプロセッサコア、システムインテグレーションブロック(以下SIB)、コミュニケーションプロセッサ(CP)から構成される高密度相補型金属酸化膜半導体(HCMOS)デバイスです。</p>
<h2 id="1-1-ブロック図"><a href="#1-1-ブロック図" class="headerlink" title="1.1 ブロック図"></a>1.1 ブロック図</h2><p>ブロック図を図1-1(準備中)に示します。</p>
<p>マイクロプロセッサコアとシリアルポート(CP内)、システムペリフェラル(SIB内)を統合することによって、IMPはすべてのISDN基本レート(2B+D)アクセスタスクのような複雑なタスクを処理することが可能です。例えば、IMPアーキテクチャとシリアル通信コントローラ(SCC)ポートは、S&#x2F;Tトランシーバチップのインターフェイスと、下位部分(ビット操作)のISO&#x2F;OSI第2層をサポートすることができます。そのほかの第2層機能および上位プロトコル層はM68000コアで実行されるソフトウェアで実装されます。</p>
<p>IMPの柔軟なメモリベース・バッファ構造を使用して、3つのSCCポートとシリアル通信ポートの間でデータバッファ情報を変換・共有することにより、ターミナルアダプタにも応用可能です。</p>
<p>各SCCチャンネルは HDLC&#x2F;SDLC1、UART、BISYNC、DDCMP2、V.110、またはトランスペアレント動作に対応します。IMPは、様々なレート適応技術に対して多くの選択肢を提供し、ターミナルコントローラ、マルチプレクサ、コンセントレータなどの機能として使用することができます。</p>
<p>MC68302は、ローカル制御バスとX.25パケットネットワークを利用したリアルタイム制御を行うボードレベルの産業用コントローラなどのアプリケーションにも使用できます。このようなシステムでは、要求の厳しい周辺機器にリアルタイムで対応しながら、X.25パケット・ネットワークを介したリモート・モニタリングや通信を可能にします。</p>
<h1 id="1-2-主な特色"><a href="#1-2-主な特色" class="headerlink" title="1.2 主な特色"></a>1.2 主な特色</h1><p>IMPの特色を以下に示します。</p>
<ul>
<li><p>8&#x2F;16ビットM68000ファミリシステムをサポートする音チップHCMOS MC68000&#x2F;68008コア</p>
</li>
<li><p>システムインテグレーションブロック</p>
<pre><code>  - 3つのハンドシェイク信号(/DREQ,/DACK,/DONE)を持つ独立DMA(IDMA)コントローラ
  - 2つの動作モードを持つ割り込みコントローラ
  - パラレルI/Oポート(一部は割り込みが使用可能)
  - オンチップの1152バイトデュアルポートRAM
  - ウォッチドッグタイマーを含む3つのタイマ
  - ウェイト・ステート・ジェネレータを含む4本のプログラマブル・チップ・セレクト
  - 出力可能なオンチップ・クロック・ジェネレータ
  - システム制御
      - 低レイテンシ・割り込み対応バス調停ロジック
      - システムステータスおよび制御ロジック
      - CPU無効化ロジック(M68000)
      - ハードウェアウォッチドッグ
      - 低消費電力(スタンバイ)モード
      - デバッグ用フリーズ制御
      - DRAMリフレッシュコントローラ
</code></pre>
</li>
<li><p>コミュニケーションプロセッサ</p>
<pre><code>      - メインコントローラ(RISCプロセッサ)
      - 独立した3つの全二重シリアル通信コントローラ(SCC)
      - 各種プロトコルをサポート
          - HDLC/SDLC(High-Level/Synchronous Data Link Control)
          - 汎用非同期送受信機(UART)
          - バイナリ同期受信(BISYNC)
          - 同期/非同期デジタルデータ通信メッセージプロトコル(DDCMP)
          - トランスペアレントモード
          - V.110レート適応
      - 3つのSCCのための6つのシリアルDMAチャネル
      - SCCからアクセス可能な柔軟な物理インターフェイス
          - モトローラインターチップデジタルリンク(IDL)
          - 一般回路インターフェイス(GCI/IOM-2)
          - パルス符号変調(PCM)ハイウェイインターフェイス
          - 非多重シリアルインターフェイス(NMSI)
          - 標準モデムの実装
              - 同期通信のためのSCP
              - IDLとGCIをサポートする2つのシリアルマネージメントコントローラ(SMC)
</code></pre>
</li>
</ul>
<h2 id="1-3-MC68302システムアーキテクチャ"><a href="#1-3-MC68302システムアーキテクチャ" class="headerlink" title="1.3 MC68302システムアーキテクチャ"></a>1.3 MC68302システムアーキテクチャ</h2><p>(工事中)</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/11/28/mc68k-c/">MC68000でCを書く</a>
            </div>
            <p class="sub">11月 28 2022</p>
            <div class="post-content">
                
                    <h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>とりあえず今の時点で上手く行った方法を書いてますが、適当に更新していくつもりです。</p>
<p>今回はgcc9.5.0をビルドしてMC68000でCのコードを走らせる方法を書いていきます。</p>
<h2 id="gccのビルド"><a href="#gccのビルド" class="headerlink" title="gccのビルド"></a>gccのビルド</h2><p><a target="_blank" rel="noopener" href="https://github.com/ddraig68k/m68k-elf-toolchain">このレポジトリ</a>の内容に従うだけです。</p>
<p>最初はCygwinでやろうと思いましたが途中でコケたのでMSYS2を導入してビルド。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">admin@LUNAEDGE-X260 MSYS ~</span><br><span class="line">$ m68k-elf-gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=m68k-elf-gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/opt/m68k-elf/libexec/gcc/m68k-elf/9.5.0/lto-wrapper</span><br><span class="line">Target: m68k-elf</span><br><span class="line">Configured with: /home/admin/m68k-elf-toolchain/projects/gcc/configure --prefix=/opt/m68k-elf --target=m68k-elf --enable-languages=c,c++,lto --enable-version-specific-runtime-libs --disable-libssp --disable-nls --disable-threads --disable-libmudflap --disable-libgomp --disable-libstdcxx-pch --with-gnu-as --with-gnu-ld --with-newlib --with-headers=/home/admin/m68k-elf-toolchain/projects/newlib-cygwin/newlib/libc/include/ --disable-shared --src=../../projects/gcc</span><br><span class="line">Thread model: single</span><br><span class="line">gcc version 9.5.0 (GCC)</span><br></pre></td></tr></table></figure>

<p>こんな感じになります(PATHもちゃんと通しておく)。</p>
<h2 id="スタートアップスクリプト"><a href="#スタートアップスクリプト" class="headerlink" title="スタートアップスクリプト"></a>スタートアップスクリプト</h2><p>ここから先は<a target="_blank" rel="noopener" href="https://kikb.web.fc2.com/">Kiさん</a>に助言を乞いながら作成しました。</p>
<p>この場を借りて感謝申し上げます。</p>
<p>今回は極力アセンブラを使わずにスタートアップルーチンを記述します。</p>
<p>割り込みベクタも最小限しか書きません。</p>
<p>最低限動くコードがこちら</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint32_t</span> __stack_top;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _init_board(<span class="type">void</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _reset_handler(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="keyword">volatile</span> <span class="type">uintptr_t</span> vectors[]</span><br><span class="line">__attribute__((section(<span class="string">&quot;.isr_vector&quot;</span>))) = &#123;</span><br><span class="line">	<span class="comment">/*Reset: Initial SSP*/</span></span><br><span class="line">	(<span class="type">uintptr_t</span>)(&amp;__stack_top),</span><br><span class="line">	<span class="comment">/*Reset: Initial PC*/</span></span><br><span class="line">	(<span class="type">uintptr_t</span>)(&amp;_reset_handler)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _init_board(<span class="type">void</span>)&#123;</span><br><span class="line">	<span class="comment">/*Do nothing*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _memcpy(<span class="type">uint8_t</span>* dst,<span class="type">uint8_t</span>* src,<span class="type">size_t</span> size)&#123;</span><br><span class="line">	<span class="keyword">while</span> (size--) &#123;</span><br><span class="line">	    *dst++ = *src++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _memclr(<span class="type">uint8_t</span>* dst,<span class="type">size_t</span> size)&#123;</span><br><span class="line">	<span class="keyword">while</span> (size--) &#123;</span><br><span class="line">	    *dst++ = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _reset_handler(<span class="type">void</span>)&#123;</span><br><span class="line">	_init_board();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*Xfer Init Value*/</span></span><br><span class="line">	<span class="keyword">extern</span> <span class="type">uint8_t</span> __data_top,__data_bottom,__text_bottom;</span><br><span class="line">	<span class="type">size_t</span> size = (<span class="type">size_t</span>)(&amp;__data_bottom - &amp;__data_top);</span><br><span class="line">	_memcpy(&amp;__data_top,&amp;__text_bottom,size);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*Memory Clear*/</span></span><br><span class="line">	<span class="keyword">extern</span> <span class="type">uint8_t</span> __bss_bottom,__bss_top;</span><br><span class="line">	size = (<span class="type">size_t</span>)(&amp;__bss_bottom - &amp;__bss_top);</span><br><span class="line">	_memclr(&amp;__bss_top,size);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*Call main()*/</span></span><br><span class="line">	main();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>スタートアップルーチンでは</p>
<ul>
<li>ボードの初期化</li>
<li>変数の初期値設定</li>
<li>main(エントリポイント)へのジャンプ</li>
</ul>
<p>を行います。</p>
<p>ここで、main関数は別ファイルでextern宣言されています。</p>
<p>MC68kのベクタは0番にSSP初期値、1番にPC初期値が入ります。</p>
<h2 id="リンカスクリプト"><a href="#リンカスクリプト" class="headerlink" title="リンカスクリプト"></a>リンカスクリプト</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">		Ricochet用Bootloader リンカスクリプト</span><br><span class="line">		2022.11.23 c0ntra1l</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">		メモリマップ(Bootloader実行時)</span><br><span class="line">		0x000000 - 0x7FFFFF	Flash*</span><br><span class="line">		0x100000 - 0x13FFFF	RAM(データ)</span><br><span class="line">		0x200000 - 0x23FFFF	RAM(プログラム)</span><br><span class="line"></span><br><span class="line">		メモリマップ(ユーザープログラム実行時)</span><br><span class="line">		0x000000 - 0x13FFFF	RAM(プログラム)*</span><br><span class="line">		0x100000 - 0x23FFFF	RAM(データ)</span><br><span class="line"></span><br><span class="line">		*:実行するプログラム</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">MEMORY &#123;</span><br><span class="line">	vec (r)		:	ORIGIN = 0x000000,	LENGTH = 0x400</span><br><span class="line">	rom	(xr)	:	ORIGIN = 0x000400,	LENGTH = 512K - 0x400</span><br><span class="line">	ram	(rw)	:	ORIGIN = 0x100000,	LENGTH = 256K</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SECTIONS &#123;</span><br><span class="line">	/*ベクタ*/</span><br><span class="line">	.isr_vector : &#123;</span><br><span class="line">		__rom_top = .;</span><br><span class="line">		__rom_vec	= .;</span><br><span class="line">	&#125; &gt; vec</span><br><span class="line"></span><br><span class="line">	/*.textセクション*/</span><br><span class="line">	.text : &#123;</span><br><span class="line">		__text_top = .;</span><br><span class="line">		*(.text*)</span><br><span class="line">		__text_bottom = .;</span><br><span class="line">		*(.rodata*)</span><br><span class="line">	&#125; &gt; rom</span><br><span class="line"></span><br><span class="line">	/*.dataセクション*/</span><br><span class="line">	.data :</span><br><span class="line">	&#123;</span><br><span class="line">		__data_top = .;</span><br><span class="line">		*(.data)</span><br><span class="line">		__data_bottom = .;</span><br><span class="line">	&#125; &gt; ram</span><br><span class="line"></span><br><span class="line">	/*.bssセクション*/</span><br><span class="line">	.bss :</span><br><span class="line">	&#123;</span><br><span class="line">		__bss_top = .;</span><br><span class="line">		*(.bss)</span><br><span class="line">		*(COMMON)</span><br><span class="line">		__bss_bottom = .;</span><br><span class="line">		__stack_top = .;</span><br><span class="line">	&#125; &gt; ram</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>メモリ配置を定義します。hoge_topとhoge_bottomはスタートアップルーチンで転送(初期化)するメモリの領域計算に使用します。</p>
<p>.dataセクションが初期値あり変数、.bssセクションが初期値なし変数、.textがプログラム、.rodataが初期値あり変数の初期値が入る領域のようです。</p>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">prefix		= m68k-elf-</span><br><span class="line">CC			= <span class="variable">$(prefix)</span>gcc</span><br><span class="line">AS			= <span class="variable">$(prefix)</span>as</span><br><span class="line">LD			= <span class="variable">$(prefix)</span>ld</span><br><span class="line">OBJCOPY		= <span class="variable">$(prefix)</span>objcopy</span><br><span class="line">OBJDUMP		= <span class="variable">$(prefix)</span>objdump</span><br><span class="line">RM			= rm</span><br><span class="line"></span><br><span class="line">PROJECT		= r68k_bootloader</span><br><span class="line">PROGRAM 	= <span class="variable">$(PROJECT)</span>.elf</span><br><span class="line">TARGET_S	= <span class="variable">$(PROJECT)</span>.s68</span><br><span class="line">TARGET_B	= <span class="variable">$(PROJECT)</span>.bin</span><br><span class="line"></span><br><span class="line">CFLAGS		= -g -O2 -m68000 -Wall -fomit-frame-pointer</span><br><span class="line">LDFLAGS 	= -Map <span class="variable">$(PROJECT)</span>.map -T ricochet.lds -nostdlib</span><br><span class="line"></span><br><span class="line">MAKEFILE	= Makefile</span><br><span class="line"></span><br><span class="line">OBJS		= main.o startup.o</span><br><span class="line"></span><br><span class="line">LIBS		=</span><br><span class="line"></span><br><span class="line"><span class="section">all:		<span class="variable">$(TARGET_B)</span> <span class="variable">$(TARGET_S)</span></span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET_B)</span>: <span class="variable">$(PROGRAM)</span></span><br><span class="line">	<span class="variable">$(OBJCOPY)</span> -O binary --remove-section=.data <span class="variable">$(PROGRAM)</span> <span class="variable">$(TARGET_B)</span></span><br><span class="line">	@echo &#x27;-------------------------------------------------------------------&#x27;</span><br><span class="line">	@echo <span class="string">&quot; <span class="variable">$(TARGET_B)</span> build succeeded. [`date`]&quot;</span></span><br><span class="line">	@echo &#x27;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET_S)</span>: <span class="variable">$(PROGRAM)</span></span><br><span class="line">	<span class="variable">$(OBJCOPY)</span> -O srec --remove-section=.data <span class="variable">$(PROGRAM)</span> <span class="variable">$(TARGET_S)</span></span><br><span class="line">	<span class="variable">$(OBJDUMP)</span> -D <span class="variable">$(PROGRAM)</span> &gt;<span class="variable">$(PROGRAM)</span>.dasm</span><br><span class="line">	<span class="variable">$(OBJDUMP)</span> -h <span class="variable">$(PROGRAM)</span></span><br><span class="line">	@echo &#x27;-------------------------------------------------------------------&#x27;</span><br><span class="line">	@echo <span class="string">&quot; <span class="variable">$(TARGET_S)</span> build succeeded. [`date`]&quot;</span></span><br><span class="line">	@echo &#x27;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="variable">$(PROGRAM)</span>: 	<span class="variable">$(OBJS)</span> <span class="variable">$(LIBS)</span></span><br><span class="line">		<span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -o <span class="variable">$(PROGRAM)</span> <span class="variable">$(OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:		%.c</span></span><br><span class="line">		<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> -f <span class="variable">$(PROGRAM)</span></span><br><span class="line">	<span class="variable">$(RM)</span> -f <span class="variable">$(TARGET_S)</span></span><br><span class="line">	<span class="variable">$(RM)</span> -f <span class="variable">$(TARGET_B)</span></span><br><span class="line">	<span class="variable">$(RM)</span> -f *.o</span><br><span class="line"></span><br><span class="line"><span class="section">tar:</span></span><br><span class="line">	cd .. &amp;&amp; tar czvf <span class="variable">$(PROJECT)</span>-`date &#x27;+%Y%m%d&#x27;`.tar.gz <span class="variable">$(PROJECT)</span></span><br></pre></td></tr></table></figure>

<p>今回はシミュレータでのテスト用にbinファイルだけでなくSレコードも出力しています。<br>また、gccのオプションに<code>-fomit-frame-pointer</code>を指定し、フレームポインタを使用しないようにしています。</p>
<h2 id="テストプログラム"><a href="#テストプログラム" class="headerlink" title="テストプログラム"></a>テストプログラム</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;startup.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">signed</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="built_in">array</span>[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">signed</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">uint8_t</span> i = <span class="number">0</span>;i &lt; <span class="number">128</span>;i++)&#123;</span><br><span class="line">		<span class="built_in">array</span>[i] = i;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>コンパイルできることをチェックするために適当なプログラムをでっちあげました。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">admin@LUNAEDGE-X260 MSYS /c/Users/Admin/Documents/Bootloader_68k</span><br><span class="line">$ make all</span><br><span class="line">m68k-elf-gcc -g -O2 -m68000 -Wall -fomit-frame-pointer -c main.c</span><br><span class="line">m68k-elf-gcc -g -O2 -m68000 -Wall -fomit-frame-pointer -c startup.c</span><br><span class="line">startup.c: In <span class="keyword">function</span> <span class="string">&#x27;_reset_handler&#x27;</span>:</span><br><span class="line">startup.c:47:2: warning: implicit declaration of <span class="keyword">function</span> <span class="string">&#x27;main&#x27;</span> [-Wimplicit-function-declaration]</span><br><span class="line">   47 |  main();</span><br><span class="line">      |  ^~~~</span><br><span class="line">m68k-elf-ld -Map r68k_bootloader.map -T ricochet.lds -nostdlib -o r68k_bootloader.elf main.o startup.o</span><br><span class="line">m68k-elf-objcopy -O binary --remove-section=.data r68k_bootloader.elf r68k_bootloader.bin</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"> r68k_bootloader.bin build succeeded. [Mon Nov 28 08:01:45 JST 2022]</span><br><span class="line"></span><br><span class="line">m68k-elf-objcopy -O srec --remove-section=.data r68k_bootloader.elf r68k_bootloader.s68</span><br><span class="line">m68k-elf-objdump -D r68k_bootloader.elf &gt;r68k_bootloader.elf.dasm</span><br><span class="line">m68k-elf-objdump -h r68k_bootloader.elf</span><br><span class="line"></span><br><span class="line">r68k_bootloader.elf:     file format elf32-m68k</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA       LMA       File off  Algn</span><br><span class="line">  0 .isr_vector   00000008  00000000  00000000  00002000  2**1</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  1 .text         00000064  00000400  00000400  00002400  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  2 .bss          00000080  00100000  00100000  00004000  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">  3 .debug_info   0000149d  00000000  00000000  00002464  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">  4 .debug_abbrev 000004b9  00000000  00000000  00003901  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">  5 .debug_loc    00000116  00000000  00000000  00003dba  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">  6 .debug_aranges 00000040  00000000  00000000  00003ed0  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">  7 .debug_ranges 00000028  00000000  00000000  00003f10  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">  8 .debug_line   00000336  00000000  00000000  00003f38  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">  9 .debug_str    0000054d  00000000  00000000  0000426e  2**0</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line"> 10 .comment      00000011  00000000  00000000  000047bb  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line"> 11 .debug_frame  00000048  00000000  00000000  000047cc  2**2</span><br><span class="line">                  CONTENTS, READONLY, DEBUGGING</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"> r68k_bootloader.s68 build succeeded. [Mon Nov 28 08:01:45 JST 2022]</span><br></pre></td></tr></table></figure>

<p><code>make all</code>を実行するとこのようになります。</p>
<p>Warningが出ていますが、コレはアセンブラを使わないようにするために<code>asm(&quot;jmp main&quot;)</code>のかわりに<code>main()</code>としたためです。</p>
<p>逆アセンブルを見てみると</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">r68k_bootloader.elf:     file format elf32-m68k</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .isr_vector:</span><br><span class="line"></span><br><span class="line">00000000 &lt;vectors&gt;:</span><br><span class="line">   0:	0010 0080      	orib #-128,%a0@</span><br><span class="line">   4:	0000 0418      	orib #24,%d0</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">00000400 &lt;main&gt;:</span><br><span class="line"> 400:	41f9 0010 0000 	lea 100000 &lt;__data_bottom&gt;,%a0</span><br><span class="line"> 406:	4200           	clrb %d0</span><br><span class="line"> 408:	10c0           	moveb %d0,%a0@+</span><br><span class="line"> 40a:	5200           	addqb #1,%d0</span><br><span class="line"> 40c:	0c00 ff80      	cmpib #-128,%d0</span><br><span class="line"> 410:	66f6           	bnes 408 &lt;main+0x8&gt;</span><br><span class="line"> 412:	7000           	moveq #0,%d0</span><br><span class="line"> 414:	4e75           	rts</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">00000418 &lt;_reset_handler&gt;:</span><br><span class="line"> 418:	203c 0010 0000 	movel #1048576,%d0</span><br><span class="line"> 41e:	0480 0010 0000 	subil #1048576,%d0</span><br><span class="line"> 424:	6718           	beqs 43e &lt;_reset_handler+0x26&gt;</span><br><span class="line"> 426:	43f9 0010 0000 	lea 100000 &lt;__data_bottom&gt;,%a1</span><br><span class="line"> 42c:	0680 0000 0464 	addil #1124,%d0</span><br><span class="line"> 432:	41f9 0000 0464 	lea 464 &lt;__text_bottom&gt;,%a0</span><br><span class="line"> 438:	12d8           	moveb %a0@+,%a1@+</span><br><span class="line"> 43a:	b1c0           	cmpal %d0,%a0</span><br><span class="line"> 43c:	66fa           	bnes 438 &lt;_reset_handler+0x20&gt;</span><br><span class="line"> 43e:	203c 0010 0080 	movel #1048704,%d0</span><br><span class="line"> 444:	0480 0010 0000 	subil #1048576,%d0</span><br><span class="line"> 44a:	6710           	beqs 45c &lt;_reset_handler+0x44&gt;</span><br><span class="line"> 44c:	41f9 0010 0000 	lea 100000 &lt;__data_bottom&gt;,%a0</span><br><span class="line"> 452:	4218           	clrb %a0@+</span><br><span class="line"> 454:	b1fc 0010 0080 	cmpal #1048704,%a0</span><br><span class="line"> 45a:	66f6           	bnes 452 &lt;_reset_handler+0x3a&gt;</span><br><span class="line"> 45c:	4eb9 0000 0400 	jsr 400 &lt;main&gt;</span><br><span class="line"> 462:	60fe           	bras 462 &lt;_reset_handler+0x4a&gt;</span><br><span class="line"></span><br><span class="line">Disassembly of section .bss:</span><br><span class="line"></span><br><span class="line">00100000 &lt;array&gt;:</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>問題なくコンパイルできているようです。</p>
<p>いろいろ気になるところはありますが、とりあえず動いたのでよしとしましょう。</p>
<p>続きは実機で動かしてからですね。</p>
<h2 id="シミュレータに突っ込む"><a href="#シミュレータに突っ込む" class="headerlink" title="シミュレータに突っ込む"></a>シミュレータに突っ込む</h2><p>S68をシミュレータに食わせてPCを0x000418にセット、走らせてメモリを覗いてみるとこんな感じになってます。</p>
<img src="/2022/11/28/mc68k-c/pgm_run.jpg" class="" title="[mc68k-c]">

<p>問題なさそうですね。</p>
<h2 id="思った点"><a href="#思った点" class="headerlink" title="思った点"></a>思った点</h2><p>今回はMC68kのシミュレータに<a target="_blank" rel="noopener" href="http://www.easy68k.com/">EASy68k</a>を使いました。</p>
<p>なかなか使いやすくて良いのですが、いろいろ不満点もあります。</p>
<ul>
<li>ベクタを読まない(開始アドレスが0x400、SSPが0x100000固定っぽい？)</li>
<li>S68だけでは逆アセンブルが表示されない(L68が必要らしい、どうすればいい？)</li>
</ul>
<p>前者は直接PCを書き換えてリセットハンドラに飛べばいいのでまだなんとかなりますが、後者はかなり厳しいです。</p>
<p>今は横に逆アセンブルリストを出して、目視でデバッグをしていますが規模が大きくなるとそれすらも大変になりそうです。</p>
<p>なんとかならないものでしょうか…</p>
<p>おわり。</p>

                
            </div>
        </article>
    
        <article class="post article-entry">
            <div class="post-title">
                <a class="post-title-link text-underline" href="/2022/11/28/made-blog/">ブログ作った</a>
            </div>
            <p class="sub">11月 28 2022</p>
            <div class="post-content">
                
                    <p>とりあえずブログをちゃんと作ってみようということで。</p>
<p>今回は自分で書くのをやめてジェネレータを使っています。</p>
<p>まぁ結局テーマにゴリゴリ手を入れているので労力としてはそんなに変わんないです。</p>
<p>あとはCloudflareのデプロイサービスを使ってみたり。</p>
<p>そんなこんなで近代的になっています。</p>

                
            </div>
        </article>
    
</div>
<div class="side-bar">


    <div class="avator" id="avator">
    <div class="title">
        <a href="#" class="text-underline">About Me</a>
    </div>
        <img src="avator.jpg" class="ava-img">
        <h3 class="author">C0ntRA1L</h3>
        <div class="icon-list">
        <a target="_blank" rel="noopener" href="https://twitter.com/LunaTsukinashi"><i class="iconfont icon-twitter icon-item"></i></a>
        <a href="mailto:tampopo@osashimi.pro"><i class="iconfont icon-email icon-item"></i></a>
        <a target="_blank" rel="noopener" href="https://github.com/Xi80"><i class="iconfont icon-github icon-item"></i></a>
        </div>
    <div class="tags">
    <h3 class="tags-title">Tags</h3>
    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E8%A8%98/" rel="tag">日記</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MC68302/" rel="tag">MC68302</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MC68000/" rel="tag">MC68000</a><span class="tag-list-count">1</span></li></ul>
</div>
		<div class="links">
			<h3 class="tags-title">Links</h3>
			<a target="_blank" rel="noopener" href="https://sites.google.com/site/happybusy/"><img src="busy_banner.png"/></a>
		</div>
    </div>
</div>

</section>



            </main>
            <div class="copyright">
  <div class="text">Powered By
    <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/Xi80/hexo-theme-Tsu_Revised">Tsu Revised</a> &copy 2022
  </div>
</div>

        </div>
    <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
    </div>
        
    </body>
    
<script src="/js/jquery-3.3.1.min.js"></script>

    
<script src="/js/back-to-top.js"></script>

    
<script src="/js/scroll.js"></script>

    <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": { 
        preferredFont: "TeX", 
        availableFonts: ["STIX","TeX"], 
        linebreaks: { automatic:true }, 
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) 
    },
    tex2jax: { 
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ], 
        processEscapes: true, 
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {  
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, 
        Macros: { href: "{}" } 
    },
    messageStyle: "none"
    }); 
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</html>
